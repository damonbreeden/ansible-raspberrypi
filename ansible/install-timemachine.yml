---
# https://mudge.name/2019/11/12/using-a-raspberry-pi-for-time-machine/#readying-our-storage
- hosts: all
  become: 'yes'
  vars:
    packages:
      - samba
      - avahi-daemon
    smb_conf_file: "/etc/samba/smb.conf"
    tm_path: "/mnt/drive1/shared/timemachine/data/"
    tm_block: |
      [global]
              map to guest = Bad User
              log file = /var/log/samba/%m
              log level = 1
      [guest]
        comment = TM
        path = {{ tm_path }}
        read only = no
        guest ok = yes
        guest only = yes
        vfs objects = catia fruit streams_xattr
        fruit:time machine = yes
  tasks:
  - name: Install packages
    apt:
      name: "{{ packages }}"
      state: latest
  - name: Update "{{smb_conf_file}}"
    blockinfile:
      path: "{{ smb_conf_file }}"
      block: "{{ tm_block }}"
      backup: yes
      validate: /usr/bin/testparm -s %s
  - name: Reload Samba
    service:
      name: smbd
      state: reloaded